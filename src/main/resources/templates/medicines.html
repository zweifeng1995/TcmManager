<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>中医管理系统</title>

    <link rel="stylesheet" type="text/css" th:href="@{/css/bootstrap.min.css}"/>
    <script type="text/javascript" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/chart.js}"></script>
    <script th:inline="javascript">
        // ================================================== 初始化参数(Start) ==================================================
        let mdcCalculationChart = null; // 药性计算直方图

        // 药性枚举类与中文的哈希表，格式：{"HOT": "热"}
        // 作用1：知道总共有哪些药性
        // 作用2：展示的时候转换为中文
        const mdcPropKindMap = [[${mdcPropKindMap}]];
        // ================================================== 初始化参数(End) ==================================================

        // ================================================== 消息展示(Start) ==================================================
        function showToast(type, message, title) {
            const toastId = 'toast-' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            <p class="text-break">
                                ${message}
                            </p>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            const toastContainer = document.getElementById('toastContainer');
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {delay: 3000});
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }
        // ================================================== 消息展示(End) ==================================================

        // ================================================== 药性计算器(Start) ==================================================
        const mdcCalculator = {
            isInit: false,
            mdcPropCalMap: new Map(), // 药性计算时需要知道要计算哪些药性，格式：{"HOT": 0}
            selectedMdcList: [], // 选中的要用于计算的药材列表

            init() { // 初始化
                Object.keys(mdcPropKindMap).forEach(key => {
                    this.mdcPropCalMap.set(key, 0);
                });
                this.isInit = true;
            },

            calculate() { // 计算药性
                // 重置计算映射
                Object.keys(mdcPropKindMap).forEach(key => {
                    this.mdcPropCalMap.set(key, 0);
                });
                // 计算药性
                for (const mdc of this.selectedMdcList) { // 遍历所有选中的药材
                    for (const prop of mdc.medicine.properties) { // 获取每个药材的药性，针对每个药材的每个药性进行计算并相加
                        const value = this.mdcPropCalMap.get(prop.kind); // 获取当前计算映射中的值
                        this.mdcPropCalMap.set( // 将新的药性计算值加到已有的值中
                            prop.kind,
                            value + prop.level * mdc.gram * mdc.weight
                        );
                    }
                }
            },

            pushMdcInfo(mdcInfo) { // 添加药材，格式：{"medicine": medicine, "weight": 1, "gram": 1}
                if (!this.isInit) {
                    console.log("The mdcCalculator does not initialize!");
                    return;
                }
                this.selectedMdcList.push(mdcInfo); // 将药材加入到选中列表中
                this.calculate(); // 重新计算药性总和
            },

            deleteMdcInfo(id) {
                this.selectedMdcList.forEach((item, index) => {
                    if (item.medicine.id == id) {
                        mdcCalculator.selectedMdcList.splice(index, 1);
                    }
                });
                this.calculate(); // 重新计算药性总和
            },

            updateMdcInfo(id, key, value) {
                mdcCalculator.selectedMdcList.forEach((item, index) => {
                    if (item.medicine.id == id) {
                        if (key == 'gram') {
                            item.gram = value;
                        }
                        if (key == 'weight') {
                            item.weight = value;
                        }
                    }
                });
                mdcCalculator.calculate();
            },

            clear() {
                if (!this.isInit) {
                    console.log("The mdcCalculator does not initialize!");
                    return;
                }
                this.selectedMdcList = []; // 清空选中列表
                this.calculate(); // 重新计算药性总和
            }
        };
        mdcCalculator.init();
        // ================================================== 药性计算器(End) ==================================================


        // ================================================== 查询药材按钮的相关操作(Start) ==================================================
        // 更新二级分类下拉列表
        function updateQuerySecondLevel() {
            const mdcCategories = [[${mdcCategories}]];
            const queryFirstLevelSelect = document.getElementById('queryFirstLevel');
            const querySecondLevelSelect = document.getElementById('querySecondLevel');
            const selectedValue = queryFirstLevelSelect.value;

            querySecondLevelSelect.innerHTML = '全选';

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '全选';
            querySecondLevelSelect.appendChild(defaultOption);

            if (mdcCategories[selectedValue] != null && mdcCategories[selectedValue].length > 0) {
                mdcCategories[selectedValue].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    querySecondLevelSelect.appendChild(option);
                });
            }
        }
        // ================================================== 查询药材按钮的相关操作(End) ==================================================

        // ================================================== 查询药材表格(Start) ==================================================
        function refreshMedicinesTable(pageNum) {
            if (pageNum == null) {
                pageNum = 1;
            }
            let queryMedicineName = document.getElementById("queryMedicineName");
            let queryEfficacy = document.getElementById("queryEfficacy");
            let queryClinicalApplication = document.getElementById("queryClinicalApplication");
            let queryFirstLevel = document.getElementById("queryFirstLevel");
            let querySecondLevel = document.getElementById("querySecondLevel");
            let queryNatureAndFlavor = document.getElementById("queryNatureAndFlavor");
            let queryChannelTropism = document.getElementById("queryChannelTropism");

            let queryString = "?pageNum=" + pageNum;
            if (queryMedicineName != null && queryMedicineName.value != null && queryMedicineName.value != "") {
                queryString += "&name=" + queryMedicineName.value;
            }
            if (queryEfficacy != null && queryEfficacy.value != null && queryEfficacy.value != "") {
                queryString += "&efficacy=" + queryEfficacy.value;
            }
            if (queryClinicalApplication != null && queryClinicalApplication.value != null && queryClinicalApplication.value != "") {
                queryString += "&clinical_application=" + queryClinicalApplication.value;
            }
            if (queryFirstLevel != null && queryFirstLevel.value != null && queryFirstLevel.value != "") {
                queryString += "&first_category=" + queryFirstLevel.value;
            }
            if (querySecondLevel != null && querySecondLevel.value != null && querySecondLevel.value != "") {
                queryString += "&second_category=" + querySecondLevel.value;
            }
            if (queryNatureAndFlavor != null && queryNatureAndFlavor.value != null && queryNatureAndFlavor.value != "") {
                queryString += "&nature_and_flavor=" + queryNatureAndFlavor.value;
            }
            if (queryChannelTropism != null && queryChannelTropism.value != null && queryChannelTropism.value != "") {
                queryString += "&channel_tropism=" + queryChannelTropism.value;
            }
            $.ajax({
                url: "/refreshMedicinesTable" + queryString,
                type: 'GET',
                success: function (data) {
                    $("#medicineTable").html(data);
                    let medicineCheckBoxList = document.getElementsByName('medicineCheckBox');
                    Array.from(medicineCheckBoxList).forEach(function (checkbox) {
                        mdcCalculator.selectedMdcList.forEach(item => {
                            if (item.medicine.id == checkbox.id) {
                                checkbox.checked = true;
                                return;
                            }
                        });
                    });
                }
            })
        }
        // ================================================== 查询药材表格(End) ==================================================

        // ================================================== 打开添加药材页面(Start) ==================================================
        function openSubmitMedicineModal() {
            const submitMedicineModal = new bootstrap.Modal(document.getElementById('submitMedicineModal'));
            submitMedicineModal.show();
        }

        function updateSecondLevelInput() {
            const mdcCategories = [[${mdcCategories}]];
            const firstLevelSelectInput = document.getElementById('firstLevelInput');
            const secondLevelSelectInput = document.getElementById('secondLevelInput');
            const selectedValueInput = firstLevelSelectInput.value;

            secondLevelSelectInput.innerHTML = '';

            if (mdcCategories[selectedValueInput] != null && mdcCategories[selectedValueInput].length > 0) {
                mdcCategories[selectedValueInput].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    secondLevelSelectInput.appendChild(option);
                });
            }
        }
        // ================================================== 打开添加药材页面(End) ==================================================

        document.addEventListener('DOMContentLoaded', function () {
            // ================================================== 初始化药性计算直方图(Start) ==================================================
            const mdcPropKindKeys = Array.from(mdcCalculator.mdcPropCalMap.keys()); // 直方图中要展示计算的药性，格式：["HOT"]
            const mdcCalChartElement = document.getElementById('mdcCalChartElement');
            mdcCalculationChart = new Chart(mdcCalChartElement, {
                type: 'bar',
                data: {
                    labels: mdcPropKindKeys.map(key => mdcPropKindMap[key]), // 药性中文名称
                    datasets: [{
                        label: '药性总和',
                        data: mdcPropKindKeys.map(key => mdcCalculator.mdcPropCalMap.get(key)), // 药性总和
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            // ================================================== 初始化药性计算直方图(End) ==================================================

            // ================================================== 添加药材(Start) ==================================================
            const submitMedicineForm = document.getElementById('submitMedicineForm');
            // 添加药材表单提交
            submitMedicineForm.addEventListener('submit', function (event) {
                event.preventDefault();
                $.ajax({
                    url: "/medicines",
                    type: "POST",
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        showToast("success", "添加药材成功！", "操作成功");
                        refreshMedicinesTable();
                        submitMedicineForm.reset();
                        updateSecondLevelInput();
                        Object.keys(mdcPropKindMap).forEach(key => {
                            document.getElementById(key).value = 0;
                            document.getElementById(key + "Span").innerText = 0;
                            document.getElementById(key + "Hidden").innerText = 0;
                        });
                    },
                    error: function (xhr, status, error) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showToast('error', "添加药材失败！\n失败原因：" + response.message, "操作失败");
                        } catch (e) {
                            showToast('error', "添加药材失败！\n失败原因：未知错误", "操作失败");
                        }
                    },
                    complete: function () {
                    }
                })
            });
            // ================================================== 添加药材(End) ==================================================

            // ================================================== 修改药材(Start) ==================================================
            const editMedicineForm = document.getElementById('editMedicineForm');
            editMedicineForm.addEventListener('submit', function (event) {
                event.preventDefault();
                $.ajax({
                    url: "/medicines",
                    type: "PUT",
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        showToast("success", "修改药材成功！", "操作成功");
                        refreshMedicinesTable();
                        editMedicineForm.reset();
                    },
                    error: function (xhr, status, error) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showToast('error', "修改药材失败！\n失败原因：" + response.message, "操作失败");
                        } catch (e) {
                            showToast('error', "修改药材失败！\n失败原因：未知错误", "操作失败");
                        }
                    },
                    complete: function () {
                    }
                })
            });
            // ================================================== 修改药材(End) ==================================================

            // ================================================== 删除药材(Start) ==================================================
            const deleteMedicinesForm = document.getElementById('deleteMedicinesForm');
            deleteMedicinesForm.addEventListener('submit', function (event) {
                event.preventDefault();
                $.ajax({
                    url: "/medicines",
                    type: "DELETE",
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        showToast("success", "删除药材成功！", "操作成功");
                        clearCalculation();
                        deleteMedicinesForm.reset();
                        refreshMedicinesTable();
                    },
                    error: function (xhr, status, error) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showToast('error', "删除药材失败！\n失败原因：" + response.message, "操作失败");
                        } catch (e) {
                            showToast('error', "删除药材失败！\n失败原因：未知错误", "操作失败");
                        }
                    },
                    complete: function () {
                    }
                })
            });
            // ================================================== 删除药材(End) ==================================================

            // ================================================== 添加药方(Start) ==================================================
            const submitPrescriptionForm = document.getElementById('submitPrescriptionForm');
            submitPrescriptionForm.addEventListener('submit', function (event) {
                event.preventDefault();
                $.ajax({
                    url: "/prescriptions",
                    type: "POST",
                    data: new FormData(this),
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        showToast("success", "药方添加成功！", "操作成功");
                    },
                    error: function (xhr, status, error) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            showToast('error', "药方添加失败！\n失败原因：" + response.message, "操作失败");
                        } catch (e) {
                            showToast('error', "药方添加失败！\n失败原因：未知错误", "操作失败");
                        }
                    },
                    complete: function () {
                    }
                })
            });
            // ================================================== 删除药方(End) ==================================================
        })

        // ================================================== 打开编辑药材页面(Start) ==================================================
        function openEditMedicineModal(button) {
            const row = button.closest('tr');
            const cells = row.getElementsByTagName('td');
            const editName = document.getElementById('editName');
            editName.value = cells[2].getElementsByTagName('p')[0].innerText;
            editName.readOnly = true;
            document.getElementById('editFirstLevelInput').value = cells[3].getElementsByTagName('p')[0].innerText;
            updateEditSecondLevelInput();
            document.getElementById('editSecondLevelInput').value = cells[4].getElementsByTagName('p')[0].innerText;
            document.getElementById('editMmpResearch').value = cells[5].getElementsByTagName('p')[0].innerText;
            document.getElementById('editNatureAndFlavor').value = cells[6].getElementsByTagName('p')[0].innerText;
            document.getElementById('editChannelTropism').value = cells[7].getElementsByTagName('p')[0].innerText;
            document.getElementById('editEfficacy').value = cells[8].getElementsByTagName('p')[0].innerText;
            document.getElementById('editClinicalApplication').value = cells[9].getElementsByTagName('p')[0].innerText;

            const rawKindShow = cells[10].getElementsByTagName('span');
            const kindShowMap = new Map();
            Array.from(rawKindShow).forEach((kind) => {
                kindKeyValue = kind.dataset.role.split(":");
                kindKey = kindKeyValue[0];
                kindValue = kindKeyValue[1];
                kindShowMap.set(kindKey, kindValue);
            });
            Object.keys(mdcPropKindMap).forEach(key => {
                document.getElementById("edit" + key).value = 0;
                document.getElementById("edit" + key + "Span").innerText = 0;
                document.getElementById("edit" + key + "Hidden").innerText = 0;
            });
            kindShowMap.forEach((value, key) => {
                document.getElementById("edit" + key).value = value;
                document.getElementById("edit" + key + "Span").innerText = value;
                document.getElementById("edit" + key + "Hidden").innerText = value;
            });

            const editMedicineModal = new bootstrap.Modal(document.getElementById('editMedicineModal'));
            editMedicineModal.show();
        }
        function updateEditSecondLevelInput() {
            let mdcCategories = [[${mdcCategories}]];
            const editFirstLevelInput = document.getElementById('editFirstLevelInput');
            const editSecondLevelInput = document.getElementById('editSecondLevelInput');
            const selectedValueInput = editFirstLevelInput.value;

            editSecondLevelInput.innerHTML = '';

            if (mdcCategories[selectedValueInput] != null && mdcCategories[selectedValueInput].length > 0) {
                mdcCategories[selectedValueInput].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    editSecondLevelInput.appendChild(option);
                });
            }
        }
        // ================================================== 打开编辑药材页面(End) ==================================================

        // ================================================== 添加药方(Start) ==================================================
        function openSubmitPrescriptionModal() {
            if (mdcCalculator.selectedMdcList.length == 0) {
                showToast('error', '请至少选择一味药材才能保存新药方！', '操作失败');
                return;
            }
            const submitPrescriptionModal = new bootstrap.Modal(document.getElementById('submitPrescriptionModal'));
            submitPrescriptionModal.show();
            const prescriptionTableBody = document.getElementById("prescriptionTableBody")
            prescriptionTableBody.innerHTML = mdcCalculator.selectedMdcList.map((medicineInfo, index) => `
                <tr>
                    <td style="text-align: center;">
                        ${index}
                    </td>
                    <td style="text-align: center;">
                        ${medicineInfo.medicine.name}
                        <input type="hidden" name="prescriptionMedicines[${index}].name" value="${medicineInfo.medicine.name}">
                    </td>
                    <td style="text-align: center;">
                        ${medicineInfo.gram}
                        <input type="hidden" name="prescriptionMedicines[${index}].gram" value="${medicineInfo.gram}">
                    </td>
                    <td style="text-align: center;">
                        ${medicineInfo.weight}
                        <input type="hidden" name="prescriptionMedicines[${index}].weight" value="${medicineInfo.weight}">
                    </td>
                </tr>
            `).join("");
        }
        // ================================================== 添加药方(End) ==================================================

        // ================================================== 更新计算器表格(Start) ==================================================
        function addOrDelToCalculator(checkbox, medicine) {
            if (mdcCalculator.selectedMdcList.length >= 50) {
                alert("1 个药方最多添加 50 个药材！");
                checkbox.checked = false;
                return;
            }
            if (checkbox.checked) { // 添加药材到计算器
                medicineInfo = {
                    "medicine": medicine,
                    "gram": 1.0,
                    "weight": 1.0
                }
                mdcCalculator.pushMdcInfo(medicineInfo);
            } else { // 从计算器中删除药材
                mdcCalculator.deleteMdcInfo(medicine.id);
            }
            refreshCalculationTable();
        }

        function updateMdcInfoInCalculator(obj, key, value) {
            mdcCalculator.updateMdcInfo(obj.dataset.id, key, value);
            refreshChart();
        }

        function deleteFromCalculator(btn) {
            const checkbox = document.getElementById(btn.value);
            if (null != checkbox) {
                checkbox.checked = false;
            }
            mdcCalculator.deleteMdcInfo(btn.value);
            refreshCalculationTable();
        }

        function clearCalculation() {
            let checkboxes = document.getElementsByName("medicineCheckBox");
            checkboxes.forEach((checkbox) => checkbox.checked = false);
            mdcCalculator.clear();
            refreshCalculationTable();
        }

        function refreshCalculationTable() {
            const calculationTable = document.getElementById("calculationTableBody");
            calculationTable.innerHTML = mdcCalculator.selectedMdcList.map((item, index) => `
                <tr>
                    <td style="text-align: center;">${index + 1}</td>
                    <td style="text-align: center;">${item.medicine.name}</td>
                    <td style="text-align: center;">
                        <div class="input-group">
                            <input type="number"
                                   class="form-control"
                                   name="weight"
                                   step="0.01"
                                   min="0.01"
                                   value="${item.gram}"
                                   data-id="${item.medicine.id}"
                                   onchange="updateMdcInfoInCalculator(this, 'gram', this.value)"
                                   required>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <div class="input-group">
                            <input type="number"
                                   class="form-control"
                                   name="coefficient"
                                   step="0.01"
                                   min="0"
                                   max="10"
                                   value="${item.weight}"
                                   data-id="${item.medicine.id}"
                                   onchange="updateMdcInfoInCalculator(this, 'weight', this.value)"
                                   required>
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <button type="submit" class="p-0 border-0 bg-transparent" onclick="deleteFromCalculator(this)" value="${item.medicine.id}">
                            <img style="height: 20px; width: 20px" src="/img/subtract.png" alt="删除"/>
                        </button>
                    </td>
                </tr>
            `).join("");

            refreshChart();

            const deleteMedicines = document.getElementById("deleteMedicines");
            let query_ids = "";
            mdcCalculator.selectedMdcList.map(item => {
                if (query_ids === "") {
                    query_ids += item.medicine.id;
                } else {
                    query_ids += "," + item.medicine.id;
                }
            })
            deleteMedicines.value = query_ids;
        }

        function refreshChart() {
            const mdcPropKindKeys = Array.from(mdcCalculator.mdcPropCalMap.keys()); // 直方图中要展示计算的药性，格式：["HOT"]
            mdcCalculationChart.data.labels =  mdcPropKindKeys.map(key => mdcPropKindMap[key]);
            mdcCalculationChart.data.datasets[0].data = mdcPropKindKeys.map(key => mdcCalculator.mdcPropCalMap.get(key));
            mdcCalculationChart.update();
        }
        // ================================================== 更新计算器表格(End) ==================================================

        // ================================================== 药性组件关联更新(Start) ==================================================
        function updateMdcPropKindSpanValue(id, value) {
            document.getElementById(id + "Span").innerText = value;
            document.getElementById(id + "Hidden").innerText = value;
        }
        // ================================================== 药性组件关联更新(End) ==================================================
    </script>
</head>

<body>
<!-- 顶部导航 -->
<nav th:replace="page_template :: top_nav"></nav>
<div class="d-flex">
    <!-- 侧边导航 -->
    <div th:replace="~{page_template :: side_nav(uri='/medicines')}"></div>
    <!-- 内容 -->
    <div class="d-flex flex-column p-3">
        <div class="row mt-3">
            <div class="col-9">
                <h2 class="fw-bold text-center">药材列表</h2>
                <div class="container-fluid rounded border border-1">
                    <div class="row my-3">
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryMdcName" class="col-3 col-form-label">
                                    <strong>名称：</strong>
                                </label>
                                <div class="col-9">
                                    <input type="text" class="form-control" name="queryMdcName" id="queryMdcName"
                                           placeholder="请输入..."/>
                                </div>
                            </div>
                        </div>
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryClinicalApplication" class="col-4 col-form-label">
                                    <strong>临床应用：</strong>
                                </label>
                                <div class="col-8">
                                    <input type="text" class="form-control" name="queryClinicalApplication"
                                           id="queryClinicalApplication" placeholder="请输入..."/>
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                        <div class="col-3"></div>
                    </div>
                    <div class="row my-3">
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryNatureAndFlavor" class="col-3 col-form-label">
                                    <strong>性味：</strong>
                                </label>
                                <div class="col-9">
                                    <input type="text" class="form-control" name="queryNatureAndFlavor"
                                           id="queryNatureAndFlavor" placeholder="请输入..."/>
                                </div>
                            </div>
                        </div>
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryChannelTropism" class="col-4 col-form-label">
                                    <strong>归经：</strong>
                                </label>
                                <div class="col-8">
                                    <input type="text" class="form-control" name="queryChannelTropism"
                                           id="queryChannelTropism" placeholder="请输入..."/>
                                </div>
                            </div>
                        </div>
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryEfficacy" class="col-3 col-form-label">
                                    <strong>功效：</strong>
                                </label>
                                <div class="col-9">
                                    <input type="text" class="form-control" name="queryEfficacy" id="queryEfficacy"
                                           placeholder="请输入..."/>
                                </div>
                            </div>
                        </div>
                        <div class="col-3"></div>
                    </div>
                    <div class="row my-3">
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryMdcName" class="col-3 col-form-label">
                                    <strong>一级分类：</strong>
                                </label>
                                <div class="col-9">
                                    <select id="queryFirstLevel" class="form-select" aria-label="一级分类"
                                            onchange="updateQuerySecondLevel()">
                                        <option selected value="">全选</option>
                                        <option th:each="category : ${mdcCategories.keySet()}"
                                                th:value="${category}" th:text="${category}"></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-3 align-middle text-nowrap">
                            <div class="row">
                                <label for="queryClinicalApplication" class="col-4 col-form-label">
                                    <strong>二级分类：</strong>
                                </label>
                                <div class="col-8">
                                    <select id="querySecondLevel" class="form-select" aria-label="二级分类">
                                        <option selected value="">全选</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-5"></div>
                        <div class="col-1 align-middle text-nowrap">
                            <button type="button" class="btn btn-primary" style="width: 100%;"
                                    onclick="refreshMedicinesTable()">查询
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-3"></div>
        </div>
        <div class="row my-3">
            <div class="col-12">
                <div class="container-flex">
                    <button type="button" class="btn btn-primary" onclick="openSubmitMedicineModal()">添加药材信息
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#deleteMedicineModal">批量删除
                    </button>
                </div>
            </div>
        </div>
        <div class="row my-3">
            <div class="col-9 overflow-auto">
                <div class="container-fluid p-0" th:fragment="medicineTable" id="medicineTable">
                    <table class="table table-striped table-hover align-middle text-nowrap">
                        <thead>
                        <tr class="table-primary">
                            <th style="text-align: center; width: 50px;">
                                #
                            </th>
                            <th style="text-align: center; width: 50px;">
                                序号
                            </th>
                            <th style="text-align: center; width: 100px;">
                                药材名
                            </th>
                            <th style="text-align: center; width: 100px;">
                                一级分类
                            </th>
                            <th style="text-align: center; width: 100px;">
                                二级分类
                            </th>
                            <th style="text-align: center; width: 200px;">
                                现代医学药理研究
                            </th>
                            <th style="text-align: center; width: 200px;">
                                性味
                            </th>
                            <th style="text-align: center; width: 200px;">
                                归经
                            </th>
                            <th style="text-align: center; width: 400px;">
                                功效
                            </th>
                            <th style="text-align: center; width: 400px;">
                                临床应用
                            </th>
                            <th style="text-align: center; width: 200px;">
                                药性
                            </th>
                            <th style="text-align: center; width: 100px;">
                                操作
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="medicine, status: ${medicineTableDTO.medicines}">
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 50px;">
                                <label>
                                    <input class="form-check-input" type="checkbox" th:id="${medicine.id}"
                                           name="medicineCheckBox"
                                           th:onclick="addOrDelToCalculator(this, [[${medicine}]])">
                                </label>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 50px;">
                                <p style="margin: 0;" th:text="${status.index + 1}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 100px;">
                                <p style="margin: 0;" th:text="${medicine.name}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 100px;">
                                <p style="margin: 0;" th:text="${medicine.firstCategory}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 150px;">
                                <p style="margin: 0;" th:text="${medicine.secondCategory}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 200px;">
                                <p style="margin: 0;" th:text="${medicine.mmpResearch}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 200px;">
                                <p style="margin: 0;" th:text="${medicine.natureAndFlavor}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 200px;">
                                <p style="margin: 0;" th:text="${medicine.channelTropism}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 400px;">
                                <p style="margin: 0;" th:text="${medicine.efficacy}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 400px;">
                                <p style="margin: 0;"
                                   th:text="${medicine.clinicalApplication}"></p>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center"
                                style="max-width: 200px;">
                                    <span class="badge bg-secondary" style="margin: 1px; font-size: small;"
                                          th:each="medicineProp : ${medicine.properties}"
                                          th:data-role="${medicineProp.kind} + ':' + ${medicineProp.level}"
                                          th:text="${medicineProp.kind.valueZhCn} + '(' + ${medicineProp.level} + ')'"></span>
                            </td>
                            <td class="overflow-auto justify-content-center align-items-center text-center">
                                <div class="d-flex justify-content-center">
                                    <a title="编辑" style="cursor:pointer" onclick="openEditMedicineModal(this)">
                                        <img style="height: 20px; width: 20px" src="/img/edit.png"
                                             alt="编辑"/>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="container-fluid p-0">
                        <div class="container d-flex justify-content-center align-items-center">
                            <ul class="pagination">
                                <li th:class="${medicineTableDTO.pageNum} > 1 ? 'page-item' : 'page-item disabled'">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable(1)">
                                        <<</p>
                                </li>
                                <li th:class="${medicineTableDTO.pageNum} > 1 ? 'page-item' : 'page-item disabled'">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum - 1}]])"><</p>
                                </li>
                                <li class="page-item" th:if="${medicineTableDTO.pageNum - 2} > 0">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum - 2}]])"
                                       th:text="${medicineTableDTO.pageNum - 2}"></p>
                                </li>
                                <li class="page-item" th:if="${medicineTableDTO.pageNum - 1} > 0">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum - 1}]])"
                                       th:text="${medicineTableDTO.pageNum - 1}"></p>
                                </li>
                                <li class="page-item active">
                                    <p class="page-link" th:text="${medicineTableDTO.pageNum}"></p>
                                </li>
                                <li class="page-item"
                                    th:if="${medicineTableDTO.pageNum + 1} <= ${medicineTableDTO.totalPage}">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum + 1}]])"
                                       th:text="${medicineTableDTO.pageNum + 1}"></p>
                                </li>
                                <li class="page-item"
                                    th:if="${medicineTableDTO.pageNum + 2} <= ${medicineTableDTO.totalPage}">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum + 2}]])"
                                       th:text="${medicineTableDTO.pageNum + 2}"></p>
                                </li>
                                <li th:class="${medicineTableDTO.pageNum} < ${medicineTableDTO.totalPage} ? 'page-item' : 'page-item disabled'">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.pageNum + 1}]])">></p>
                                </li>
                                <li th:class="${medicineTableDTO.pageNum} < ${medicineTableDTO.totalPage} ? 'page-item' : 'page-item disabled'">
                                    <p class="page-link" style="cursor: pointer"
                                       th:onclick="refreshMedicinesTable([[${medicineTableDTO.totalPage}]])">>></p>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-3">
                <div class="panel panel-default border rounded p-3">
                    <div class="panel-heading">
                        <h4 class="panel-title fw-bold text-center">药性计算面板</h4>
                    </div>
                    <div class="panel-body">
                        <div class="container-fluid overflow-auto mb-3" style="max-height: 600px;">
                            <table class="table table-bordered border-dark table-striped table-hover align-middle text-nowrap"
                                   id="calculationTable" style="width: 100%;">
                                <thead>
                                <tr>
                                    <th style="text-align: center; vertical-align: middle; width: 50px; min-width: 50px; background-color: #EDE2C9;">
                                        序号
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; width: 150px; min-width: 150px; background-color: #EDE2C9;">
                                        药材名
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; width: 100px; min-width: 100px;background-color: #EDE2C9;">
                                        克数<br/>(单位:g)
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; width: 100px; min-width: 100px; background-color: #EDE2C9;">
                                        权重<br/>(1-10)
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; width: 50px; min-width: 50px; background-color: #EDE2C9;">
                                        操作
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="calculationTableBody"></tbody>
                            </table>
                        </div>
                        <div>
                            <canvas id="mdcCalChartElement"></canvas>
                        </div>
                    </div>
                    <div class="d-flex flex-row-reverse">
                        <button class="btn btn-primary m-1" onclick="openSubmitPrescriptionModal()">
                            保存为新药方
                        </button>
                        <button class="btn btn-primary m-1" onclick="clearCalculation()">
                            清空
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="submitMedicineModal">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <strong class="fas fa-user-edit me-2">添加药材</strong>
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <form id="submitMedicineForm" method="POST" th:action="@{/medicines}" th:object="${submitMedicineDTO}"
                      autocomplete="off">
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <strong>药材名：</strong>
                                </label>
                                <label>
                                    <input type="text" class="form-control" placeholder="请输入..." maxlength="32"
                                           th:field="*{name}">
                                </label>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <strong class="col-md-2 col-form-label">一级分类：</strong>
                            <div class="col-md-4">
                                <select id="firstLevelInput" class="form-select" aria-label="一级分类"
                                        onchange="updateSecondLevelInput()" name="firstCategory">
                                    <option th:each="category : ${mdcCategories.keySet()}"
                                            th:selected="${category == '暂未归类'}" th:value="${category}"
                                            th:text="${category}"></option>
                                </select>
                            </div>
                            <strong class="col-md-2 col-form-label">二级分类：</strong>
                            <div class="col-md-4">
                                <select id="secondLevelInput" class="form-select" aria-label="二级分类"
                                        th:field="*{secondCategory}">
                                    <option selected th:value="${mdcCategories.get('暂未归类')}"
                                            th:text="${mdcCategories.get('暂未归类')[0]}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>性味：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{natureAndFlavor}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>归经：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{channelTropism}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>功效：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{efficacy}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>临床应用：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{clinicalApplication}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>现代医学药理研究：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{mmpResearch}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>药性：</strong>
                            </label>
                            <div class="col-md-6" th:each="mdcProp, status : *{properties}">
                                <div style="float: left; width: 20%; text-align: left;"
                                     th:text="${mdcProp.kind.valueZhCn}"></div>
                                <div style="float: left; width: 60%;">
                                    <label style="width: 100%">
                                        <input class="form-range"
                                               type="range"
                                               min="0"
                                               max="10"
                                               step="1"
                                               th:id="${mdcProp.kind}"
                                               th:field="*{properties[__${status.index}__].level}"
                                               th:value="${mdcProp.level} != null ? ${mdcProp.level} : 0"
                                               th:onchange="updateMdcPropKindSpanValue(this.id, this.value)">
                                    </label>
                                </div>
                                <span style="float: left; width: 15%; margin-left: 5%;" th:id="${mdcProp.kind + 'Span'}"
                                      th:text="${mdcProp.level} != null ? ${mdcProp.level} : 0"></span>
                                <input type="hidden" th:id="${mdcProp.kind + 'Hidden'}"
                                       th:field="*{properties[__${status.index}__].kind}"/>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">确认</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editMedicineModal">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <strong class="fas fa-user-edit me-2">编辑药材</strong>
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editMedicineForm" method="PUT" th:action="@{/medicines}" th:object="${editMedicineDTO}"
                      autocomplete="off">
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <strong>药材名：</strong>
                                </label>
                                <label>
                                    <input type="text" class="form-control" id="editName" th:field="*{name}"
                                           style="background-color: #f5f5f5; color: #666; cursor: not-allowed;">
                                </label>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <strong class="col-md-2 col-form-label">一级分类：</strong>
                            <div class="col-md-4">
                                <select id="editFirstLevelInput" class="form-select" aria-label="一级分类"
                                        onchange="updateEditSecondLevelInput()" th:field="*{firstCategory}">
                                    <option th:each="category : ${mdcCategories.keySet()}"
                                            th:selected="${category == '暂未归类'}" th:value="${category}"
                                            th:text="${category}"></option>
                                </select>
                            </div>
                            <strong class="col-md-2 col-form-label">二级分类：</strong>
                            <div class="col-md-4">
                                <select id="editSecondLevelInput" class="form-select" aria-label="二级分类"
                                        th:field="*{secondCategory}">
                                    <option selected th:value="${mdcCategories.get('暂未归类')}"
                                            th:text="${mdcCategories.get('暂未归类')}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>性味：</strong>
                            </label>
                            <label>
                                <textarea id="editNatureAndFlavor" class="form-control" rows="3" placeholder="请输入..."
                                          maxlength="64" th:field="*{natureAndFlavor}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>归经：</strong>
                            </label>
                            <label>
                                <textarea id="editChannelTropism" class="form-control" rows="3" placeholder="请输入..."
                                          maxlength="64" th:field="*{channelTropism}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>功效：</strong>
                            </label>
                            <label>
                                <textarea id="editEfficacy" class="form-control" rows="3" placeholder="请输入..."
                                          maxlength="64" th:field="*{efficacy}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>临床应用：</strong>
                            </label>
                            <label>
                                <textarea id="editClinicalApplication" class="form-control" rows="3"
                                          placeholder="请输入..." maxlength="64"
                                          th:field="*{clinicalApplication}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>现代医学药理研究：</strong>
                            </label>
                            <label>
                                <textarea id="editMmpResearch" class="form-control" rows="3" placeholder="请输入..."
                                          maxlength="64" th:field="*{mmpResearch}"></textarea>
                            </label>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>药性：</strong>
                            </label>
                            <div class="col-md-6" th:each="mdcProp, status : *{properties}">
                                <div style="float: left; width: 20%; text-align: left;"
                                     th:text="${mdcProp.kind.valueZhCn}"></div>
                                <div style="float: left; width: 60%;">
                                    <label style="width: 100%">
                                        <input class="form-range"
                                               type="range"
                                               min="0"
                                               max="10"
                                               step="1"
                                               th:id="${'edit' + mdcProp.kind}"
                                               th:field="*{properties[__${status.index}__].level}"
                                               th:value="${mdcProp.level} != null ? ${mdcProp.level} : 0"
                                               th:onchange="updateMdcPropKindSpanValue(this.id, this.value)">
                                    </label>
                                </div>
                                <span style="float: left; width: 15%; margin-left: 5%;"
                                      th:id="${'edit' + mdcProp.kind + 'Span'}"
                                      th:text="${mdcProp.level} != null ? ${mdcProp.level} : 0"></span>
                                <input type="hidden" th:id="${'edit' + mdcProp.kind + 'Hidden'}"
                                       th:field="*{properties[__${status.index}__].kind}"/>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">修改</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteMedicineModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">永久删除该药材</h4>
                </div>
                <div class="modal-body">
                    <h6>确认要删除选中的药材吗？</h6>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <form th:action="@{/medicines}" th:method="DELETE" id="deleteMedicinesForm">
                        <input type="hidden" id="deleteMedicines" name="ids">
                        <button type="submit" class="btn btn-danger" data-bs-dismiss="modal">确认</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="submitPrescriptionModal">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <strong class="fas fa-user-edit me-2">药方详情</strong>
                    </h5>
                    <button type="button" class="btn-close" aria-label="Close" data-bs-dismiss="modal"></button>
                </div>
                <form id="submitPrescriptionForm" method="POST" th:action="@{/prescriptions}"
                      th:object="${prescriptionDTO}" autocomplete="off">
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">
                                    <strong>药方名：</strong>
                                </label>
                                <label>
                                    <input type="text" class="form-control" placeholder="请输入..." maxlength="32"
                                           th:field="*{prescriptionName}">
                                </label>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <label class="form-label">
                                <strong>药方描述：</strong>
                            </label>
                            <label>
                                <textarea class="form-control" rows="3" placeholder="请输入..." maxlength="2048"
                                          th:field="*{prescriptionDesc}"></textarea>
                            </label>
                        </div>
                        <div>
                            <label class="form-label">
                                <strong>药材列表：</strong>
                            </label>
                            <table class="table table-bordered border-dark table-striped table-hover align-middle text-nowrap">
                                <thead>
                                <tr>
                                    <th style="text-align: center; vertical-align: middle; min-width: 50px; background-color: #EDE2C9;">
                                        序号
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; min-width: 150px; background-color: #EDE2C9;">
                                        药材名
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; min-width: 100px;background-color: #EDE2C9;">
                                        克数<br/>
                                    </th>
                                    <th style="text-align: center; vertical-align: middle; min-width: 80px;background-color: #EDE2C9;">
                                        权重<br/>
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="prescriptionTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            取消
                        </button>
                        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"
         style="position: fixed; top: 100px; right: 20px; z-index: 1055; min-width: 300px;"></div>
</div>
<!-- 底部 -->
<footer>
    <div th:replace="page_template :: footer"></div>
</footer>
</body>
</html>
